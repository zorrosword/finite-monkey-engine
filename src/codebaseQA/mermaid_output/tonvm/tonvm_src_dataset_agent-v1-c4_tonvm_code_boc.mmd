## å¼ºåŒ–åˆ†ææè¿°

å¯¹ `./src/dataset/agent-v1-c4/tonvm/code/boc/boc.cpp` è¿›è¡Œ**å…¨å‡½æ•°è¦†ç›–åˆ†æ**ï¼Œå‘ç°ä»¥ä¸‹æ‰€æœ‰å‡½æ•°ï¼š

**å·²è¦†ç›–çš„å‡½æ•°ï¼š**
- âœ… `CellSerializationInfo::init(td::Slice data, int ref_byte_size)` - ä»æ•°æ®åˆ‡ç‰‡åˆå§‹åŒ–
- âœ… `CellSerializationInfo::init(td::uint8 d1, td::uint8 d2, int ref_byte_size)` - ä»å­—èŠ‚å¯¹åˆå§‹åŒ–
- âœ… `CellSerializationInfo::get_bits(td::Slice cell) const` - è·å–ä½æ•°
- âœ… `CellSerializationInfo::create_data_cell(td::Slice cell_slice, td::Span<Ref<Cell>> refs) const` - åˆ›å»ºæ•°æ®å•å…ƒæ ¼
- âœ… `BagOfCells::clear()` - æ¸…ç©ºå®¹å™¨
- âœ… `BagOfCells::set_roots(const std::vector<td::Ref<vm::Cell>>& new_roots)` - è®¾ç½®æ ¹èŠ‚ç‚¹é›†åˆ
- âœ… `BagOfCells::set_root(td::Ref<vm::Cell> new_root)` - è®¾ç½®å•ä¸ªæ ¹èŠ‚ç‚¹
- âœ… `BagOfCells::add_roots(const std::vector<td::Ref<vm::Cell>>& add_roots)` - æ·»åŠ æ ¹èŠ‚ç‚¹é›†åˆ
- âœ… `BagOfCells::add_root(td::Ref<vm::Cell> add_root)` - æ·»åŠ å•ä¸ªæ ¹èŠ‚ç‚¹
- âœ… `BagOfCells::import_cells()` - å¯¼å…¥æ‰€æœ‰å•å…ƒæ ¼
- âœ… `BagOfCells::import_cell(td::Ref<vm::Cell> cell, int depth)` - å¯¼å…¥å•ä¸ªå•å…ƒæ ¼

**æ–°å‘ç°çš„é—æ¼å‡½æ•°ï¼ˆéœ€è¦è¡¥å……ï¼‰ï¼š**
- ğŸ” **BagOfCells::cells_clear()** - æ¸…ç©ºå•å…ƒæ ¼åˆ—è¡¨ï¼ˆå†…éƒ¨å‡½æ•°ï¼‰
- ğŸ” **BagOfCells::reorder_cells()** - é‡æ–°æ’åºå•å…ƒæ ¼ï¼ˆå†…éƒ¨å‡½æ•°ï¼‰
- ğŸ” **BagOfCells::get_cell_count() const** - è·å–å•å…ƒæ ¼æ•°é‡ï¼ˆgetterï¼‰
- ğŸ” **BagOfCells::get_root_count() const** - è·å–æ ¹èŠ‚ç‚¹æ•°é‡ï¼ˆgetterï¼‰
- ğŸ” **BagOfCells::serialize_to_slice() const** - åºåˆ—åŒ–åˆ°åˆ‡ç‰‡
- ğŸ” **BagOfCells::compute_sizes()** - è®¡ç®—åºåˆ—åŒ–å¤§å°
- ğŸ” **CellSerializationInfo getterå‡½æ•°ç¾¤** - å„ç§åç§»é‡å’Œé•¿åº¦è·å–å‡½æ•°

è¿™äº›é—æ¼çš„å‡½æ•°ä¸»è¦åŒ…æ‹¬å†…éƒ¨ç®¡ç†å‡½æ•°ã€getterç±»å‹çš„æŸ¥è¯¢å‡½æ•°å’Œåºåˆ—åŒ–ç›¸å…³çš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•°ï¼Œéœ€è¦åœ¨æµç¨‹å›¾ä¸­è¡¥å……å®Œæ•´çš„äº¤äº’æµç¨‹ã€‚

## å¼ºåŒ–åçš„å®Œæ•´ä¸šåŠ¡æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as User
    participant BagOfCells as BagOfCells
    participant CellSerializationInfo as CellSerializationInfo
    participant DataCell as DataCell
    participant Cell as Cell
    participant Logger as BagOfCellsLogger

    %% ========== BagOfCells å®¹å™¨ç®¡ç†é˜¶æ®µ ==========
    Note over User,Logger: BagOfCells å®¹å™¨åˆå§‹åŒ–å’Œç®¡ç†

    %% æ¸…ç©ºæ“ä½œ
    User->>BagOfCells: clear()
    BagOfCells->>BagOfCells: cells_clear()
    BagOfCells->>BagOfCells: roots.clear()
    BagOfCells->>BagOfCells: root_count = 0
    BagOfCells->>BagOfCells: serialized.clear()
    Note right of BagOfCells: å®Œå…¨æ¸…ç©º BOC å®¹å™¨

    %% å†…éƒ¨å•å…ƒæ ¼æ¸…ç©ºå‡½æ•°
    User->>BagOfCells: cells_clear()
    BagOfCells->>BagOfCells: æ¸…ç©ºå†…éƒ¨å•å…ƒæ ¼æ•°æ®ç»“æ„
    Note right of BagOfCells: å†…éƒ¨å‡½æ•°ï¼šæ¸…ç©ºå•å…ƒæ ¼åˆ—è¡¨

    %% æ ¹èŠ‚ç‚¹è®¾ç½®ï¼ˆæ›¿æ¢æ¨¡å¼ï¼‰
    User->>BagOfCells: set_roots(const std::vector<td::Ref<vm::Cell>>& new_roots)
    BagOfCells->>BagOfCells: clear()
    BagOfCells->>BagOfCells: add_roots(new_roots)
    BagOfCells->>User: return td::Status
    Note right of BagOfCells: æ¸…ç©ºåè®¾ç½®æ–°çš„æ ¹èŠ‚ç‚¹é›†åˆ

    User->>BagOfCells: set_root(td::Ref<vm::Cell> new_root)
    BagOfCells->>BagOfCells: clear()
    BagOfCells->>BagOfCells: add_root(std::move(new_root))
    BagOfCells->>User: return td::Status
    Note right of BagOfCells: æ¸…ç©ºåè®¾ç½®å•ä¸ªæ ¹èŠ‚ç‚¹

    %% æ ¹èŠ‚ç‚¹æ·»åŠ ï¼ˆè¿½åŠ æ¨¡å¼ï¼‰
    User->>BagOfCells: add_roots(const std::vector<td::Ref<vm::Cell>>& add_roots)
    loop éå†æ‰€æœ‰æ ¹èŠ‚ç‚¹
        BagOfCells->>BagOfCells: add_root(std::move(root))
    end
    BagOfCells->>User: return int (æ·»åŠ çš„æ ¹èŠ‚ç‚¹æ•°é‡)
    Note right of BagOfCells: æ‰¹é‡æ·»åŠ æ ¹èŠ‚ç‚¹

    User->>BagOfCells: add_root(td::Ref<vm::Cell> add_root)
    BagOfCells->>BagOfCells: æ£€æŸ¥ add_root.is_null()
    alt æ ¹èŠ‚ç‚¹ä¸ºç©º
        BagOfCells->>User: return 0
    else æ ¹èŠ‚ç‚¹æœ‰æ•ˆ
        BagOfCells->>BagOfCells: éªŒè¯è™šæ‹ŸåŒ–çº§åˆ« == 0
        BagOfCells->>BagOfCells: roots.emplace_back(std::move(add_root), -1)
        BagOfCells->>BagOfCells: ++root_count
        BagOfCells->>BagOfCells: cells_clear()
        BagOfCells->>User: return 1
    end
    Note right of BagOfCells: æ·»åŠ å•ä¸ªæ ¹èŠ‚ç‚¹å¹¶éªŒè¯

    %% Getter å‡½æ•°ç¾¤
    User->>BagOfCells: get_cell_count() const
    BagOfCells->>User: return size_t (å•å…ƒæ ¼æ•°é‡)
    Note right of BagOfCells: è·å–å•å…ƒæ ¼æ€»æ•°

    User->>BagOfCells: get_root_count() const
    BagOfCells->>User: return size_t (æ ¹èŠ‚ç‚¹æ•°é‡)
    Note right of BagOfCells: è·å–æ ¹èŠ‚ç‚¹æ€»æ•°

    %% ========== å•å…ƒæ ¼å¯¼å…¥å’Œå¤„ç†é˜¶æ®µ ==========
    Note over User,Logger: å•å…ƒæ ¼å¯¼å…¥ã€éªŒè¯å’Œé‡æ’åº

    %% å¯¼å…¥æ‰€æœ‰å•å…ƒæ ¼
    User->>BagOfCells: import_cells()
    BagOfCells->>Logger: logger_ptr_->start_stage("import_cells")
    BagOfCells->>BagOfCells: cells_clear()
    
    loop éå†æ‰€æœ‰æ ¹èŠ‚ç‚¹
        BagOfCells->>BagOfCells: import_cell(root.cell, 0)
        alt å¯¼å…¥æˆåŠŸ
            BagOfCells->>BagOfCells: root.idx = res.move_as_ok()
        else å¯¼å…¥å¤±è´¥
            BagOfCells->>User: return td::Status::Error
        end
    end
    
    BagOfCells->>BagOfCells: reorder_cells()
    BagOfCells->>BagOfCells: CHECK(cell_count != 0)
    BagOfCells->>Logger: logger_ptr_->finish_stage(cell_count + " cells")
    BagOfCells->>User: return td::Status::OK()
    Note right of BagOfCells: å¯¼å…¥æ‰€æœ‰æ ¹èŠ‚ç‚¹å…³è”çš„å•å…ƒæ ¼

    %% å¯¼å…¥å•ä¸ªå•å…ƒæ ¼
    User->>BagOfCells: import_cell(td::Ref<vm::Cell> cell, int depth)
    BagOfCells->>BagOfCells: æ£€æŸ¥ depth > max_depth
    alt æ·±åº¦è¶…é™
        BagOfCells->>User: return td::Status::Error("cell depth too large")
    else æ·±åº¦æ­£å¸¸
        BagOfCells->>BagOfCells: æ£€æŸ¥ cell.is_null()
        alt å•å…ƒæ ¼ä¸ºç©º
            BagOfCells->>User: return td::Status::Error("cell is null")
        else å•å…ƒæ ¼æœ‰æ•ˆ
            BagOfCells->>Logger: logger_ptr_->on_cells_processed(1)
            BagOfCells->>BagOfCells: æŸ¥æ‰¾ cells.find(cell->get_hash())
            alt å•å…ƒæ ¼å·²å­˜åœ¨
                BagOfCells->>BagOfCells: cell_list_[pos].should_cache = true
                BagOfCells->>User: return pos
            else å•å…ƒæ ¼ä¸å­˜åœ¨
                BagOfCells->>BagOfCells: éªŒè¯è™šæ‹ŸåŒ–çº§åˆ« == 0
                BagOfCells->>BagOfCells: åˆ›å»ºæ–°çš„ CellInfo å¹¶æ·»åŠ åˆ° cell_list_
                BagOfCells->>BagOfCells: é€’å½’å¯¼å…¥å­å•å…ƒæ ¼å¼•ç”¨
                BagOfCells->>User: return new_pos
            end
        end
    end
    Note right of BagOfCells: é€’å½’å¯¼å…¥å•ä¸ªå•å…ƒæ ¼åŠå…¶å¼•ç”¨

    %% é‡æ–°æ’åºå•å…ƒæ ¼
    User->>BagOfCells: reorder_cells()
    BagOfCells->>BagOfCells: æ‰§è¡Œæ‹“æ‰‘æ’åºç®—æ³•
    BagOfCells->>BagOfCells: æ›´æ–°å•å…ƒæ ¼ç´¢å¼•æ˜ å°„
    Note right of BagOfCells: å†…éƒ¨å‡½æ•°ï¼šä¼˜åŒ–å•å…ƒæ ¼å­˜å‚¨é¡ºåº

    %% è®¡ç®—åºåˆ—åŒ–å¤§å°
    User->>BagOfCells: compute_sizes()
    BagOfCells->>BagOfCells: è®¡ç®—æ‰€æœ‰å•å…ƒæ ¼çš„åºåˆ—åŒ–å¤§å°
    BagOfCells->>BagOfCells: æ›´æ–°å†…éƒ¨å¤§å°ç»Ÿè®¡
    Note right of BagOfCells: è®¡ç®—åºåˆ—åŒ–æ‰€éœ€çš„æ€»å¤§å°

    %% åºåˆ—åŒ–åˆ°åˆ‡ç‰‡
    User->>BagOfCells: serialize_to_slice() const
    BagOfCells->>BagOfCells: å°† BOC æ•°æ®åºåˆ—åŒ–åˆ°å†…å­˜åˆ‡ç‰‡
    BagOfCells->>User: return td::Slice (åºåˆ—åŒ–æ•°æ®)
    Note right of BagOfCells: å°†æ•´ä¸ª BOC åºåˆ—åŒ–ä¸ºå­—èŠ‚æµ

    %% ========== CellSerializationInfo å¤„ç†é˜¶æ®µ ==========
    Note over User,DataCell: å•å…ƒæ ¼åºåˆ—åŒ–ä¿¡æ¯è§£æå’ŒéªŒè¯

    %% ä»æ•°æ®åˆ‡ç‰‡åˆå§‹åŒ–
    User->>CellSerializationInfo: init(td::Slice data, int ref_byte_size)
    CellSerializationInfo->>CellSerializationInfo: æ£€æŸ¥ data.size() >= 2
    alt æ•°æ®é•¿åº¦ä¸è¶³
        CellSerializationInfo->>User: return td::Status::Error("Not enough bytes")
    else æ•°æ®é•¿åº¦è¶³å¤Ÿ
        CellSerializationInfo->>CellSerializationInfo: init(data.ubegin()[0], data.ubegin()[1], ref_byte_size)
        CellSerializationInfo->>CellSerializationInfo: æ£€æŸ¥ data.size() >= end_offset
        alt æ•°æ®é•¿åº¦ä¸è¶³
            CellSerializationInfo->>User: return td::Status::Error("Not enough bytes")
        else æ•°æ®é•¿åº¦è¶³å¤Ÿ
            CellSerializationInfo->>User: return td::Status::OK()
        end
    end
    Note right of CellSerializationInfo: ä»æ•°æ®åˆ‡ç‰‡åˆå§‹åŒ–åºåˆ—åŒ–ä¿¡æ¯

    %% ä»å­—èŠ‚å¯¹åˆå§‹åŒ–
    User->>CellSerializationInfo: init(td::uint8 d1, td::uint8 d2, int ref_byte_size)
    CellSerializationInfo->>CellSerializationInfo: refs_cnt = d1 & 7
    CellSerializationInfo->>CellSerializationInfo: level_mask = Cell::LevelMask(d1 >> 5)
    CellSerializationInfo->>CellSerializationInfo: special = (d1 & 8) != 0
    CellSerializationInfo->>CellSerializationInfo: with_hashes = (d1 & 16) != 0
    
    CellSerializationInfo->>CellSerializationInfo: æ£€æŸ¥ refs_cnt > 4
    alt å¼•ç”¨æ•°é‡å¼‚å¸¸
        CellSerializationInfo->>CellSerializationInfo: æ£€æŸ¥ refs_cnt == 7 && with_hashes
        alt ç¼ºå¤±å•å…ƒæ ¼æ ‡è®°
            CellSerializationInfo->>User: return td::Status::Error("TODO: absent cells")
        else æ— æ•ˆç¬¬ä¸€å­—èŠ‚
            CellSerializationInfo->>User: return td::Status::Error("Invalid first byte")
        end
    else å¼•ç”¨æ•°é‡æ­£å¸¸
        CellSerializationInfo->>CellSerializationInfo: è®¡ç®—å„ç§åç§»é‡
        CellSerializationInfo->>CellSerializationInfo: hashes_offset = 2
        CellSerializationInfo->>CellSerializationInfo: depth_offset = hashes_offset + (with_hashes ? n * Cell::hash_bytes : 0)
        CellSerializationInfo->>CellSerializationInfo: data_offset = depth_offset + (with_hashes ? n * Cell::depth_bytes : 0)
        CellSerializationInfo->>CellSerializationInfo: data_len = (d2 >> 1) + (d2 & 1)
        CellSerializationInfo->>CellSerializationInfo: data_with_bits = (d2 & 1) != 0
        CellSerializationInfo->>CellSerializationInfo: refs_offset = data_offset + data_len
        CellSerializationInfo->>CellSerializationInfo: end_offset = refs_offset + refs_cnt * ref_byte_size
        CellSerializationInfo->>User: return td::Status::OK()
    end
    Note right of CellSerializationInfo: è§£æåºåˆ—åŒ–æ ¼å¼çš„æ§åˆ¶å­—èŠ‚

    %% è·å–ä½æ•°
    User->>CellSerializationInfo: get_bits(td::Slice cell) const
    CellSerializationInfo->>CellSerializationInfo: æ£€æŸ¥ data_with_bits
    alt åŒ…å«ä½æ ‡è®°
        CellSerializationInfo->>CellSerializationInfo: DCHECK(data_len != 0)
        CellSerializationInfo->>CellSerializationInfo: int last = cell[data_offset + data_len - 1]
        CellSerializationInfo->>CellSerializationInfo: æ£€æŸ¥ !(last & 0x7f)
        alt è¿‡é•¿ç¼–ç 
            CellSerializationInfo->>User: return td::Status