## ä¸šåŠ¡æµç¨‹æ€»ç»“

tonvm_db é¡¹ç›®æ˜¯TONè™šæ‹Ÿæœºçš„æ ¸å¿ƒæ•°æ®åº“ç³»ç»Ÿï¼Œæä¾›äº†å®Œæ•´çš„Cellå­˜å‚¨ã€ç®¡ç†å’Œè®¿é—®åŠŸèƒ½ã€‚æ ¸å¿ƒä¸šåŠ¡æµç¨‹åŒ…æ‹¬ï¼š

1. **æ•°æ®åº“åˆå§‹åŒ–å’Œé…ç½®** - DynamicBagOfCellsDbImplã€CellDbReaderImplç­‰æ ¸å¿ƒç»„ä»¶çš„æž„é€ å’Œåˆå§‹åŒ–
2. **Cellå­˜å‚¨å’ŒåŠ è½½** - é€šè¿‡CellLoaderã€CellStorerå®žçŽ°Cellçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–
3. **å¤šç§å­˜å‚¨åŽç«¯æ”¯æŒ** - åŒ…æ‹¬å†…å­˜å­˜å‚¨(MapStorage)ã€æ–‡ä»¶å­˜å‚¨ã€å“ˆå¸Œå­˜å‚¨ç­‰
4. **é™æ€å’ŒåŠ¨æ€BOCç®¡ç†** - StaticBagOfCellsDbç³»åˆ—å’ŒDynamicBocCellLoaderæä¾›ä¸åŒåœºæ™¯çš„Cellè®¿é—®
5. **çº¿ç¨‹å®‰å…¨å’Œå¹¶å‘æŽ§åˆ¶** - TsVectorã€SeqLockã€ParallelRunnerç­‰ç¡®ä¿å¤šçº¿ç¨‹çŽ¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§
6. **æ™ºèƒ½åˆçº¦æ”¯æŒ** - SmartContractDbImplå’ŒSmartContractMetaæä¾›åˆçº¦çŠ¶æ€ç®¡ç†
7. **Blobæ•°æ®è§†å›¾** - BlobViewç³»åˆ—æä¾›çµæ´»çš„æ•°æ®è®¿é—®æ–¹å¼ï¼Œæ”¯æŒå†…å­˜ç¼“å†²åŒºå’Œæ–‡ä»¶æ˜ å°„
8. **äº‹åŠ¡ç®¡ç†** - TonDbTransactionImplæä¾›å®Œæ•´çš„äº‹åŠ¡æ”¯æŒ

æ‰€æœ‰ç»„ä»¶éƒ½åŒ…å«å®Œæ•´çš„getter/setteræ–¹æ³•ã€æž„é€ /æžæž„å‡½æ•°ï¼Œä»¥åŠæ ¸å¿ƒä¸šåŠ¡é€»è¾‘å‡½æ•°ï¼Œå½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åº“ç”Ÿæ€ç³»ç»Ÿã€‚

## ä¼˜åŒ–åŽçš„å®Œæ•´ä¸šåŠ¡æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as User/Client
    participant DBOC as DynamicBagOfCellsDbImpl
    participant Reader as CellDbReaderImpl
    participant HashTable as HashTable
    participant CellLoader as CellLoader
    participant CellStorer as CellStorer
    participant Counter as ThreadSafeCounter
    participant RootCell as RootCell
    participant StaticBOC as StaticBagOfCellsDb
    participant StaticBaseline as StaticBagOfCellsDbBaseline
    participant StaticLazy as StaticBagOfCellsDbLazy
    participant StaticExtCell as StaticBocExtCell
    participant DummyStorage as DummyStorage
    participant MapStorage as MapStorage
    participant HashStorage as HashStorage
    participant TsVector as TsVector
    participant DynamicBocCellLoader as DynamicBocCellLoader
    participant SeqLock as SeqLock
    participant CellInfo as CellInfo
    participant ParallelRunner as ParallelRunner
    participant UniqueAccess as UniqueAccess
    participant ArenaAllocator as ArenaAllocator
    participant CellCounter as CellCounter
    participant CellHashTable as CellHashTable
    participant DenseCellHashTable as DenseCellHashTable
    participant SmartContractMeta as SmartContractMeta
    participant SmartContractDbImpl as SmartContractDbImpl
    participant TonDbTransactionImpl as TonDbTransactionImpl
    participant KeyValue as KeyValue
    participant BagOfCells as BagOfCells
    participant ExtCellCreator as ExtCellCreator
    participant StorerT as StorerT
    participant ParserT as ParserT
    participant BlobView as BlobView
    participant BufferSliceBlobView as BufferSliceBlobView
    participant BufferSliceBlobViewImpl as BufferSliceBlobViewImpl
    participant FileBlobViewImpl as FileBlobViewImpl
    participant FileBlobView as FileBlobView
    participant FileMemoryMappingBlobView as FileMemoryMappingBlobView
    participant FileMemoryMappingBlobViewImpl as FileMemoryMappingBlobViewImpl
    participant FileFd as FileFd
    participant MemoryMapping as MemoryMapping

    %% ===== ç³»ç»Ÿåˆå§‹åŒ–é˜¶æ®µ =====
    Note over User, MemoryMapping: ðŸš€ ç³»ç»Ÿåˆå§‹åŒ–é˜¶æ®µ - æ ¸å¿ƒç»„ä»¶æž„é€ å’Œé…ç½®

    %% æ ¸å¿ƒæ•°æ®åº“ç»„ä»¶åˆå§‹åŒ–
    User->>DBOC: DynamicBagOfCellsDbImpl()
    DBOC->>Counter: get_thread_safe_counter().add(1)
    DBOC->>DBOC: åˆå§‹åŒ–å†…éƒ¨çŠ¶æ€
    
    User->>Reader: CellDbReaderImpl(db)
    Reader->>Reader: db_(db)
    Reader->>Reader: è®¾ç½®è¯»å–å™¨çŠ¶æ€
    
    %% è®¡æ•°å™¨å’Œç»Ÿè®¡ç»„ä»¶åˆå§‹åŒ–
    User->>Counter: ThreadSafeCounter()
    Counter->>Counter: åˆå§‹åŒ–åŽŸå­è®¡æ•°å™¨
    
    User->>CellCounter: CellCounter()
    CellCounter->>CellCounter: åˆå§‹åŒ–è®¡æ•°å™¨
    
    User->>CellInfo: CellInfo()
    CellInfo->>CellInfo: åˆå§‹åŒ–cell_info_
    
    User->>CellInfo: get_thread_safe_counter()
    CellInfo-->>User: thread_safe_counter

    %% ===== å­˜å‚¨åŽç«¯åˆå§‹åŒ–é˜¶æ®µ =====
    Note over User, MemoryMapping: ðŸ’¾ å­˜å‚¨åŽç«¯åˆå§‹åŒ– - å¤šç§å­˜å‚¨æ–¹å¼é…ç½®

    User->>DummyStorage: DummyStorage()
    DummyStorage->>DummyStorage: åˆå§‹åŒ–ç©ºå­˜å‚¨
    
    User->>MapStorage: MapStorage()
    MapStorage->>MapStorage: åˆå§‹åŒ–map_å­˜å‚¨
    
    User->>HashStorage: HashStorage()
    HashStorage->>HashStorage: åˆå§‹åŒ–hashå­˜å‚¨
    
    %% å“ˆå¸Œè¡¨ç»„ä»¶åˆå§‹åŒ–
    User->>CellHashTable: CellHashTable()
    CellHashTable->>CellHashTable: åˆå§‹åŒ–å“ˆå¸Œè¡¨
    
    User->>DenseCellHashTable: DenseCellHashTable()
    DenseCellHashTable->>DenseCellHashTable: åˆå§‹åŒ–å¯†é›†å“ˆå¸Œè¡¨

    %% ===== çº¿ç¨‹å®‰å…¨å’Œå¹¶å‘æŽ§åˆ¶åˆå§‹åŒ– =====
    Note over User, MemoryMapping: ðŸ”’ å¹¶å‘æŽ§åˆ¶åˆå§‹åŒ– - çº¿ç¨‹å®‰å…¨æœºåˆ¶é…ç½®

    User->>TsVector: TsVector()
    TsVector->>TsVector: åˆå§‹åŒ–data_å’Œmutex_
    
    User->>SeqLock: SeqLock()
    SeqLock->>SeqLock: seq_(0)
    
    User->>ParallelRunner: ParallelRunner(thread_count)
    ParallelRunner->>ParallelRunner: åˆå§‹åŒ–çº¿ç¨‹æ± 
    
    User->>UniqueAccess: UniqueAccess()
    UniqueAccess->>UniqueAccess: åˆå§‹åŒ–è®¿é—®æŽ§åˆ¶
    
    User->>ArenaAllocator: ArenaAllocator()
    ArenaAllocator->>ArenaAllocator: åˆå§‹åŒ–å†…å­˜æ± 

    %% ===== RootCellå’Œé™æ€BOCåˆå§‹åŒ– =====
    Note over User, MemoryMapping: ðŸ“¦ é™æ€BOCç³»ç»Ÿåˆå§‹åŒ– - æ ¹Cellå’Œé™æ€æ•°æ®åº“é…ç½®

    User->>RootCell: create(cell, extra)
    RootCell->>RootCell: Ref<RootCell>(true, std::move(cell), std::forward<T>(extra), PrivateTag{})
    RootCell-->>User: Ref<RootCell>
    
    User->>StaticBOC: StaticBagOfCellsDb(root)
    StaticBOC->>StaticBOC: root_(std::move(root))
    
    User->>StaticBaseline: StaticBagOfCellsDbBaseline(root)
    StaticBaseline->>StaticBaseline: root_(std::move(root))
    
    User->>StaticLazy: StaticBagOfCellsDbLazy(root, loader)
    StaticLazy->>StaticLazy: root_(std::move(root)), loader_
    
    User->>StaticExtCell: StaticBocExtCell(cell, db)
    StaticExtCell->>StaticExtCell: cell_(std::move(cell)), db_(db)

    %% ===== Blobè§†å›¾ç³»ç»Ÿåˆå§‹åŒ– =====
    Note over User, MemoryMapping: ðŸ—‚ï¸ Blobè§†å›¾ç³»ç»Ÿåˆå§‹åŒ– - æ•°æ®è®¿é—®å±‚é…ç½®

    User->>BufferSliceBlobView: create(td::BufferSlice slice)
    BufferSliceBlobView->>BufferSliceBlobViewImpl: BufferSliceBlobViewImpl(slice)
    BufferSliceBlobViewImpl->>BufferSliceBlobViewImpl: slice_(std::move(slice))
    BufferSliceBlobViewImpl-->>BufferSliceBlobView: å®žçŽ°å®žä¾‹
    BufferSliceBlobView-->>User: BlobViewå®žä¾‹
    
    User->>FileBlobView: create(td::CSlice file_path, td::uint64 file_size)
    FileBlobView->>FileFd: FileFd::open(file_path)
    FileFd-->>FileBlobView: æ–‡ä»¶æè¿°ç¬¦
    FileBlobView->>FileBlobView: éªŒè¯æ–‡ä»¶å¤§å°
    FileBlobView->>FileBlobViewImpl: FileBlobViewImpl(fd, file_size)
    FileBlobViewImpl->>FileBlobViewImpl: åˆå§‹åŒ–æ–‡ä»¶å¤§å°å‚æ•°å’Œé¡µé¢ç¼“å­˜
    FileBlobViewImpl-->>FileBlobView: å®žçŽ°å®žä¾‹
    FileBlobView-->>User: BlobViewå®žä¾‹
    
    User->>FileMemoryMappingBlobView: create(td::CSlice file_path, td::uint64 file_size)
    FileMemoryMappingBlobView->>MemoryMapping: MemoryMapping::create_from_file(file_path)
    MemoryMapping-->>FileMemoryMappingBlobView: å†…å­˜æ˜ å°„
    FileMemoryMappingBlobView->>FileMemoryMappingBlobViewImpl: FileMemoryMappingBlobViewImpl(mapping)
    FileMemoryMappingBlobViewImpl->>FileMemoryMappingBlobViewImpl: mapping_(std::move(mapping))
    FileMemoryMappingBlobViewImpl-->>FileMemoryMappingBlobView: å®žçŽ°å®žä¾‹
    FileMemoryMappingBlobView-->>User: BlobViewå®žä¾‹

    %% ===== æ™ºèƒ½åˆçº¦å’Œäº‹åŠ¡ç³»ç»Ÿåˆå§‹åŒ– =====
    Note over User, MemoryMapping: ðŸ¤– æ™ºèƒ½åˆçº¦ç³»ç»Ÿåˆå§‹åŒ– - åˆçº¦ç®¡ç†å’Œäº‹åŠ¡æ”¯æŒ

    User->>SmartContractMeta: SmartContractMeta()
    SmartContractMeta->>SmartContractMeta: åˆå§‹åŒ–å…ƒæ•°æ®
    
    User->>SmartContractDbImpl: SmartContractDbImpl()
    SmartContractDbImpl->>SmartContractDbImpl: åˆå§‹åŒ–åˆçº¦æ•°æ®åº“
    
    User->>TonDbTransactionImpl: TonDbTransactionImpl()
    TonDbTransactionImpl->>TonDbTransactionImpl: åˆå§‹åŒ–äº‹åŠ¡
    
    User->>KeyValue: KeyValue()
    KeyValue->>KeyValue: åˆå§‹åŒ–é”®å€¼å­˜å‚¨
    
    User->>BagOfCells: BagOfCells()
    BagOfCells->>BagOfCells: åˆå§‹åŒ–CellåŒ…
    
    User->>ExtCellCreator: ExtCellCreator()
    ExtCellCreator->>ExtCellCreator: åˆå§‹åŒ–åˆ›å»ºå™¨

    %% ===== æ ¸å¿ƒä¸šåŠ¡æ“ä½œé˜¶æ®µ =====
    Note over User, MemoryMapping: âš¡ æ ¸å¿ƒä¸šåŠ¡æ“ä½œé˜¶æ®µ - æ•°æ®è¯»å†™å’Œå¤„ç†

    %% çº¿ç¨‹å®‰å…¨å‘é‡æ“ä½œ
    User->>TsVector: get(i)
    TsVector->>TsVector: std::lock_guard<std::mutex> guard(mutex_)
    TsVector->>TsVector: æ£€æŸ¥ç´¢å¼•èŒƒå›´
    TsVector-->>User: data_[i]
    
    User->>TsVector: set(i, value)
    TsVector->>TsVector: std::lock_guard<std::mutex> guard(mutex_)
    TsVector->>TsVector: æ‰©å±•data_å¤§å°å¦‚éœ€è¦
    TsVector->>TsVector: data_[i] = std::move(value)

    %% åºåˆ—é”æ“ä½œ
    User->>SeqLock: lock_write()
    SeqLock->>SeqLock: seq_.fetch_add(1)
    SeqLock-->>User: WriteAccess
    
    User->>SeqLock: lock_read()
    SeqLock->>SeqLock: è¯»å–seq_å€¼
    SeqLock-->>User: ReadAccess

    %% å†…å­˜åˆ†é…æ“ä½œ
    User->>ArenaAllocator: alloc(size)
    ArenaAllocator->>ArenaAllocator: ä»Žå†…å­˜æ± åˆ†é…
    ArenaAllocator-->>User: å†…å­˜æŒ‡é’ˆ

    %% è®¡æ•°å™¨æ“ä½œ
    User->>CellCounter: inc()
    CellCounter->>CellCounter: åŽŸå­é€’å¢ž
    
    User->>CellCounter: dec()
    CellCounter->>CellCounter: åŽŸå­é€’å‡

    %% ===== Cellå­˜å‚¨å’ŒåŠ è½½æ“ä½œ =====
    Note over User, MemoryMapping: ðŸ“Š Cellæ•°æ®æ“ä½œ - å­˜å‚¨ã€åŠ è½½å’Œç®¡ç†

    %% å“ˆå¸Œè¡¨æ“ä½œ
    User->>CellHashTable: get_cell(hash)
    CellHashTable->>CellHashTable: æŸ¥æ‰¾å“ˆå¸Œå¯¹åº”çš„cell
    CellHashTable-->>User: cellæˆ–nullptr
    
    User->>CellHashTable: set_cell(hash, cell)
    CellHashTable->>CellHashTable: å­˜å‚¨cellåˆ°å“ˆå¸Œè¡¨
    
    User->>DenseCellHashTable: get_cell(hash)
    DenseCellHashTable->>DenseCellHashTable: é«˜æ•ˆæŸ¥æ‰¾cell
    DenseCellHashTable-->>User: cellæˆ–nullptr

    %% åŠ¨æ€BOC CellåŠ è½½
    User->>DynamicBocCellLoader: DynamicBocCellLoader(db)
    DynamicBocCellLoader->>DynamicBocCellLoader: db_(db)
    
    User->>DynamicBocCellLoader: load(hash, need_data, ext_cell_creator)
    DynamicBocCellLoader->>DBOC: load_cell(hash)
    DBOC-->>DynamicBocCellLoader: cell_data
    DynamicBocCellLoader->>CellLoader: parse(parser, ext_cell_creator)
    CellLoader->>ParserT: è¯»å–Cellæ ¼å¼æ ‡è¯†
    ParserT-->>CellLoader: æ ¼å¼ä¿¡æ¯
    CellLoader->>CellLoader: æ ¹æ®æ ¼å¼è§£æžCellæ•°æ®
    CellLoader-->>DynamicBocCellLoader: loaded_cell
    DynamicBocCellLoader-->>User: loaded_cell

    %% CellåŠ è½½å™¨æ ¸å¿ƒåŠŸèƒ½
    User->>CellLoader: CellLoader(need_data)
    CellLoader->>CellLoader: need_data_(need_data)
    
    User->>CellLoader: parse(parser, ext_cell_creator)
    CellLoader->>ParserT: è¯»å–Cellæ ¼å¼æ ‡è¯†
    ParserT-->>CellLoader: æ ¼å¼ä¿¡æ¯
    CellLoader->>CellLoader: æ ¹æ®æ ¼å¼è§£æžCellæ•°æ®
    CellLoader-->>User: loaded_cell

    %% =====