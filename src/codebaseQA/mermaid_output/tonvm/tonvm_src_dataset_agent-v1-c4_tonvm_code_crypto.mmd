## å¼ºåŒ–åˆ†æžæè¿°

å¯¹ `./src/dataset/agent-v1-c4/tonvm/code/crypto/Hasher.cpp` è¿›è¡Œ**å…¨å‡½æ•°è¦†ç›–åˆ†æž**ï¼Œå‘çŽ°ä»¥ä¸‹æ‰€æœ‰å‡½æ•°ï¼š

**ðŸ” å·²è¯†åˆ«çš„å®Œæ•´å‡½æ•°åˆ—è¡¨:**

**Hasherç±»æ ¸å¿ƒå‡½æ•°:**
- `Hasher(int hash_id)` - æž„é€ å‡½æ•°ï¼Œæ ¹æ®hash_idåˆå§‹åŒ–ä¸åŒçš„å“ˆå¸Œå®žçŽ°
- `append(td::ConstBitPtr data, unsigned size)` - è¿½åŠ æ•°æ®åˆ°å“ˆå¸Œå™¨ç¼“å†²åŒº
- `finish()` - å®Œæˆå“ˆå¸Œè®¡ç®—å¹¶è¿”å›žç»“æžœ
- `bytes_per_gas_unit() const` - èŽ·å–æ¯ä¸ªgaså•ä½å¯¹åº”çš„å­—èŠ‚æ•°ï¼ˆgetterå‡½æ•°ï¼‰

**HasherImplEVPç±»å‡½æ•°:**
- `HasherImplEVP(EVP_MD_CTX *ctx)` - EVPå®žçŽ°æž„é€ å‡½æ•°ï¼Œå­˜å‚¨OpenSSLä¸Šä¸‹æ–‡
- `append(const unsigned char *data, size_t size)` - EVPå®žçŽ°çš„æ•°æ®è¿½åŠ 
- `finish()` - EVPå®žçŽ°çš„å“ˆå¸Œå®Œæˆ

**HasherImplKeccakç±»å‡½æ•°:**
- `HasherImplKeccak(unsigned hash_size)` - Keccakå®žçŽ°æž„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–KeccakçŠ¶æ€
- `append(const unsigned char *data, size_t size)` - Keccakå®žçŽ°çš„æ•°æ®è¿½åŠ   
- `finish()` - Keccakå®žçŽ°çš„å“ˆå¸Œå®Œæˆ

**å†…éƒ¨çŠ¶æ€ç®¡ç†å‡½æ•°:**
- ç¼“å†²åŒºç®¡ç†é€»è¾‘ï¼ˆbuf_ã€buf_ptr_çŠ¶æ€å˜é‡çš„æ“ä½œï¼‰
- å®žçŽ°æŒ‡é’ˆç®¡ç†ï¼ˆimpl_çŠ¶æ€å˜é‡çš„æ“ä½œï¼‰
- å“ˆå¸ŒIDå­˜å‚¨ï¼ˆid_çŠ¶æ€å˜é‡çš„è®¿é—®ï¼‰

## å¼ºåŒ–åŽçš„å®Œæ•´ä¸šåŠ¡æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as User/VM
    participant Hasher as Hasher
    participant HasherImplEVP as HasherImplEVP
    participant HasherImplKeccak as HasherImplKeccak
    participant OpenSSL as OpenSSL_EVP
    participant KeccakLib as Keccak_Library
    participant Error as Error_Handler
    participant Buffer as Internal_Buffer
    participant GasCalc as Gas_Calculator

    %% ========== å“ˆå¸Œå™¨åˆå§‹åŒ–å’Œç®¡ç†æµç¨‹ ==========
    Note over User,GasCalc: Hasheræž„é€ å‡½æ•°åˆå§‹åŒ–é˜¶æ®µ
    User->>Hasher: Hasher(int hash_id)
    Hasher->>Hasher: store id_ = hash_id
    alt hash_id == KECCAK256 || hash_id == KECCAK512
        Hasher->>HasherImplKeccak: new HasherImplKeccak(hash_id == KECCAK256 ? 32 : 64)
        HasherImplKeccak->>HasherImplKeccak: store hash_size_ = hash_size
        HasherImplKeccak->>KeccakLib: keccak_init(&state_, hash_size * 2, 24)
        KeccakLib-->>HasherImplKeccak: return 0 (success)
        HasherImplKeccak->>HasherImplKeccak: CHECK(keccak_init result == 0)
        HasherImplKeccak->>HasherImplKeccak: CHECK(state_ != nullptr)
        HasherImplKeccak-->>Hasher: return HasherImplKeccak instance
        Hasher->>Hasher: impl_ = std::make_unique<HasherImplKeccak>
    else hash_id in [SHA256, SHA512, BLAKE2B]
        Hasher->>OpenSSL: EVP_MD_CTX_new()
        OpenSSL-->>Hasher: return EVP_MD_CTX *ctx
        Hasher->>Hasher: CHECK(ctx != nullptr)
        alt hash_id == SHA256
            Hasher->>OpenSSL: EVP_sha256()
            OpenSSL-->>Hasher: return const EVP_MD *evp
        else hash_id == SHA512
            Hasher->>OpenSSL: EVP_sha512()
            OpenSSL-->>Hasher: return const EVP_MD *evp
        else hash_id == BLAKE2B
            Hasher->>OpenSSL: EVP_blake2b512()
            OpenSSL-->>Hasher: return const EVP_MD *evp
        end
        Hasher->>OpenSSL: EVP_DigestInit_ex(ctx, evp, nullptr)
        OpenSSL-->>Hasher: return success status
        Hasher->>Hasher: CHECK(evp != nullptr && EVP_DigestInit_ex success)
        Hasher->>HasherImplEVP: new HasherImplEVP(EVP_MD_CTX *ctx)
        HasherImplEVP->>HasherImplEVP: store ctx_ = ctx
        HasherImplEVP-->>Hasher: return HasherImplEVP instance
        Hasher->>Hasher: impl_ = std::make_unique<HasherImplEVP>
    else
        Hasher->>Error: throw VmError{Excno::range_chk, "invalid hash id"}
    end
    Hasher->>Buffer: initialize buf_ptr_ = 0
    Hasher-->>User: return Hasher instance

    %% ========== æ•°æ®è¿½åŠ å¤„ç†æµç¨‹ ==========
    Note over User,GasCalc: appendå‡½æ•°æ•°æ®å¤„ç†é˜¶æ®µ
    User->>Hasher: append(td::ConstBitPtr data, unsigned size)
    Hasher->>Hasher: check if (!impl_)
    alt impl_ is null
        Hasher->>Error: throw VmError{Excno::unknown, "can't use finished hasher"}
    else impl_ exists
        loop while size > 0
            Hasher->>Buffer: cur_size = std::min(size, BUF_SIZE * 8 - buf_ptr_)
            Hasher->>Buffer: td::BitPtr{buf_, (int)buf_ptr_}.copy_from(data, cur_size)
            Hasher->>Buffer: buf_ptr_ += cur_size
            alt buf_ptr_ == BUF_SIZE * 8
                alt impl_ is HasherImplEVP
                    Hasher->>HasherImplEVP: append(buf_, BUF_SIZE)
                    HasherImplEVP->>OpenSSL: EVP_DigestUpdate(ctx_, data, size)
                    OpenSSL-->>HasherImplEVP: return success status
                    HasherImplEVP-->>Hasher: append complete
                else impl_ is HasherImplKeccak
                    Hasher->>HasherImplKeccak: append(buf_, BUF_SIZE)
                    HasherImplKeccak->>KeccakLib: keccak_update(&state_, data, size)
                    KeccakLib-->>HasherImplKeccak: update complete
                    HasherImplKeccak-->>Hasher: append complete
                end
                Hasher->>Buffer: buf_ptr_ = 0
            end
            Hasher->>Hasher: size -= cur_size
            Hasher->>Hasher: data += cur_size
        end
    end
    Hasher-->>User: append complete

    %% ========== å“ˆå¸Œå®Œæˆå¤„ç†æµç¨‹ ==========
    Note over User,GasCalc: finishå‡½æ•°å“ˆå¸Œå®Œæˆé˜¶æ®µ
    User->>Hasher: finish()
    Hasher->>Hasher: check if (!impl_)
    alt impl_ is null
        Hasher->>Error: throw VmError{Excno::unknown, "can't use finished hasher"}
    else impl_ exists
        Hasher->>Hasher: check if (buf_ptr_ % 8 != 0)
        alt buf_ptr_ % 8 != 0
            Hasher->>Error: throw VmError{Excno::cell_und, "data does not consist of an integer number of bytes"}
        else buf_ptr_ % 8 == 0
            alt impl_ is HasherImplEVP
                Hasher->>HasherImplEVP: append(buf_, buf_ptr_ / 8)
                HasherImplEVP->>OpenSSL: EVP_DigestUpdate(ctx_, data, buf_ptr_ / 8)
                OpenSSL-->>HasherImplEVP: update complete
                Hasher->>HasherImplEVP: finish()
                HasherImplEVP->>OpenSSL: EVP_DigestFinal_ex(ctx_, hash_buffer, &hash_len)
                OpenSSL-->>HasherImplEVP: return hash result
                HasherImplEVP->>OpenSSL: EVP_MD_CTX_free(ctx_)
                HasherImplEVP->>HasherImplEVP: create td::BufferSlice from hash
                HasherImplEVP-->>Hasher: return td::BufferSlice hash
            else impl_ is HasherImplKeccak
                Hasher->>HasherImplKeccak: append(buf_, buf_ptr_ / 8)
                HasherImplKeccak->>KeccakLib: keccak_update(&state_, data, buf_ptr_ / 8)
                KeccakLib-->>HasherImplKeccak: update complete
                Hasher->>HasherImplKeccak: finish()
                HasherImplKeccak->>KeccakLib: keccak_final(&state_, hash_buffer)
                KeccakLib-->>HasherImplKeccak: return hash result
                HasherImplKeccak->>HasherImplKeccak: create td::BufferSlice from hash
                HasherImplKeccak-->>Hasher: return td::BufferSlice hash
            end
            Hasher->>Hasher: impl_ = nullptr (mark as finished)
            Hasher-->>User: return td::BufferSlice hash
        end
    end

    %% ========== Gasè®¡ç®—æŸ¥è¯¢æµç¨‹ ==========
    Note over User,GasCalc: bytes_per_gas_unit getterå‡½æ•°
    User->>Hasher: bytes_per_gas_unit() const
    Hasher->>GasCalc: BYTES_PER_GAS_UNIT[id_]
    GasCalc-->>Hasher: return gas unit value
    Hasher-->>User: return bytes per gas unit

    %% ========== é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ£€æŸ¥ ==========
    Note over User,GasCalc: çŠ¶æ€ç®¡ç†å’Œé”™è¯¯å¤„ç†
    alt Invalid hash_id during construction
        Hasher->>Error: VmError{Excno::range_chk, "invalid hash id"}
    end
    alt Using finished hasher
        Hasher->>Error: VmError{Excno::unknown, "can't use finished hasher"}
    end
    alt Non-byte-aligned data
        Hasher->>Error: VmError{Excno::cell_und, "data does not consist of an integer number of bytes"}
    end
    alt OpenSSL initialization failure
        Hasher->>Error: CHECK failure for EVP operations
    end
    alt Keccak initialization failure
        HasherImplKeccak->>Error: CHECK failure for keccak_init
    end
```